<!DOCTYPE html>
<html>
	<head>
		<title>memcpy.io | Android: Enabling mainline graphics</title>
		<link rel="icon" type="image/png" href="/logo.png" />
		<link rel="stylesheet" type="text/css" href="/theme/css/fonts.css">
		<link rel="stylesheet" type="text/css" href="/theme/css/math.css">
        <link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="/theme/css/page.css">
		<link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="memcpy.io atom feed" />
		<link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="memcpy.io RSS feed" />
		<meta charset="utf-8">
		<meta name="robots" content="index,follow">
		<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- TODO: is this still required in 2015? -->
		<meta name="description" content="The HWC (Hardware Composer) API is used by SurfaceFlinger for compositing layers to the screen. The HWC abstracts objects such as overlays and 2D blitters and helps offload some work that would normally be done with OpenGL. SurfaceFlinger on the other hand accepts buffers from multiple sources, composites them, and sends them to the display. The above graphic depicts the traditional Android graphics stack. This is where drm_hwcomposer comes into play. Since the mainline kernel graphics stack doesn&#39;t offer the HWC API, drm_hwcomposer is introduced to interface with the mainline graphics stack through mesa and libdrm. Before this work drm_hwcomposer only offered the HWC1 API. Since Android 7.0 version 2 of the HWC API is used by SurfaceFlinger. HWC2 differs in a few ways â€¦">
		<meta name="author" content="Robert Foss">
		<meta name="keywords" content="Robert Foss memcpy Robert Foss, Open Source, Software, Linux, Embedded, Engineer, android, aosp, graphics, drm, drm_hwcomposer, hwcomposer, hwc2, collabora">
		<meta property="og:title" content="Android: Enabling mainline graphics" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://memcpy.io//images/2017-03-28_android_graphics_stack.png" />
		<meta property="og:url" content="https://memcpy.io/android-enabling-mainline-graphics.html" />
		<meta property="og:locale" content="" />
		<meta property="og:site_name" content="memcpy.io" />
		<meta property="article:published_time" content="2017-03-28" />
		<meta property="article:section" content="aosp" />
		<meta property="article:tag" content="android" />
		<meta property="article:tag" content="aosp" />
		<meta property="article:tag" content="graphics" />
		<meta property="article:tag" content="drm" />
		<meta property="article:tag" content="drm_hwcomposer" />
		<meta property="article:tag" content="hwcomposer" />
		<meta property="article:tag" content="hwc2" />
		<meta property="article:tag" content="collabora" />
	</head>
	<body>
		<article id="content" itemscope>
			<header>
				<h1>Android: Enabling mainline graphics</h1>
				<p>
				Published <time datetime="2017-03-28" itemprop="datePublished">2017-03-28</time>
				</p>
			</header>
			<p>Android uses the HWC API to communicate with graphics hardware. This API is not supported on the mainline Linux graphics stack, but by using drm_hwcomposer as a shim it now is.</p>
			<p>The  <a href="https://source.android.com/devices/graphics/implement-hwc.html">HWC</a> 
(Hardware Composer) API is used by SurfaceFlinger for compositing layers to the screen.
The HWC abstracts objects such as overlays and 2D blitters and helps offload some work
that would normally be done with OpenGL.
SurfaceFlinger on the other hand accepts buffers from multiple sources, composites them,
and sends them to the display.</p>
<p><a href="/images/2017-03-28_android_graphics_stack.png"><img alt="Alt text" src="/images/2017-03-28_android_graphics_stack.png" title="Android Graphics Stack"></a></p>
<p>The above graphic depicts the traditional Android graphics stack.</p>
<p>This is where drm_hwcomposer comes into play. Since the mainline kernel graphics stack
doesn't offer the HWC API, drm_hwcomposer is introduced to interface with the mainline
graphics stack through mesa and libdrm. Before this work drm_hwcomposer only offered the
HWC1 API.
Since Android 7.0 version 2 of the HWC API is used by SurfaceFlinger. HWC2 differs in a few
ways from the previous version, for example the semantics of fence support were changed and
the GPU can now be used as a fallback when compositing layers.</p>
<p>Up until recently the mainline kernel lacked the fence primitive offered by Android
used in HWC1 and HWC2. But after my fellow Collaboran Gustavo Padovan's work on
<a href="http://padovan.org/blog/2016/09/mainline-explicit-fencing-part-1/">adding fence support</a>
to the mainline kernel was upstreamed in
<a href="http://padovan.org/blog/2017/02/collabora-contributions-to-linux-kernel-4-10/">v4.10</a>,
the mainline kernel now has fence support equivalent to that of Android.</p>
<p>The new fence support enabled work on drm_hwcomposer to add HWC2 support.
And with it we are now able to boot Android on the db410c running the freedreno driver.
But in theory it should work on any mainline kernel graphics stack enabled GPU.</p>
<p>Currently the work is being upstreamed to the
<a href="https://chromium.googlesource.com/chromiumos/drm_hwcomposer/">ChromiumOS repo</a>
which is the official upstream for drm_hwcomposer.</p>
<p>A number of projects have seen contributions 8in order to enable this work:</p>
<ul>
<li>kernel - sync_file, in-fence and out-fence support added.</li>
<li>libdrm - fence support added.</li>
<li>mesa - support for passing fences added.</li>
<li>intel-gpu-tools - sync and fence tests added.</li>
<li>drm_hwcomposer - HWC2 and fence support added.</li>
</ul>
<h2>Thanks</h2>
<p>This drm_hwcomposer work is part of a long-standing collaboration between
Google's ChromeOS team and Collabora.</p>
<p>A number of people have played an important role in this work:
Gustavo Padovan, Rob Clark, Sean Paul, Zach Reizner and Rob Herring.</p>
<p>This post has been a part of work undertaken by my employer <a href="http://www.collabora.com">Collabora</a>.</p>
		</article>
		<section id="teaser-section">
			<div id="teaser">
				<p>Tags:
					<a href="./tag/android.html">android </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/aosp.html">aosp </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/graphics.html">graphics </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/drm.html">drm </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/drm_hwcomposer.html">drm_hwcomposer </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/hwcomposer.html">hwcomposer </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/hwc2.html">hwc2 </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/collabora.html">collabora </a>
				</p>
			</div>
		</section>
		<footer>
			<div id="footer">
				<p id="notices" class="smcp">
					<a href="/about.html">About</a>
					<span id="breakdot">&middot;</span>
					<a href="/index.html">Blog</a>
					<span id="breakdot">&middot;</span>
					<a href="/talks.html">Talks</a>
					<span id="breakdot">&middot;</span>
					<a href="/contact.html">Contact</a>
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss">GitHub</a>
					<br>
					<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Copyleft</a>
					<span id="breakdot">&middot;</span>
					2018 Robert Foss
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss/memcpy.io">Source</a>
					<br>
					<a href="/"><img src="/logo.png"></a>
				</p>
			</div>
		</footer>
	</body>
</html>