<!DOCTYPE html>
<html>
	<head>
		<title>memcpy.io | Building Android for Qemu with Mesa and Virgil3D</title>
		<script src="https://cdn.nocodeflow.net/tools/geoblock.js"></script>
		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="stylesheet" type="text/css" href="/theme/css/fonts.css">
		<link rel="stylesheet" type="text/css" href="/theme/css/math.css">
		<link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
		<link rel="canonical" href="https://memcpy.io/building-android-for-qemu-with-mesa-and-virgil3d.html">
		<link rel="stylesheet" type="text/css" href="/theme/css/page.css">
		<link href="https://memcpy.io/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="memcpy.io ATOM Feed" />
		<link href="https://memcpy.io/feeds/all.atom.xml" type="application/rss+xml" rel="alternate" title="memcpy.io RSS Feed" />
		<meta name="google-site-verification" content="M7TRHJxGB04WWoywNbib8VC7rcbyjs7aMI2Bnkh6XqA" />
		<meta charset="utf-8">
		<meta name="robots" content="index,follow">
		<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- TODO: is this still required in 2015? -->
		<meta name="description" content="Developing Linux for Android on Qemu allows you to do some things that are not necessarily possible using the stock emulator. For my purposes I need access to a GPU and be able to modify the driver, which is where Virgilrenderer and Qemu comes in handy. The guide below helps you compile Android and run it on top of Qemu with Mesa/Virgilrenderer supplying a virtual GPU. Because of this, the following guide is aimed at Linux hosts. This guide is based on Rob Herrings fantastic guide, but has been slightly streamlined and had physical hardware support stripped out. Install dependencies These dependencies were available on Ubuntu 16.04, some alternative packages might be needed for other distributions. sudo apt install autoconf gcc-aarch64-linux â€¦">
		<meta name="author" content="Robert Foss">
		<meta name="keywords" content="Robert Foss memcpy Robert Foss, Open Source, Software, Linux, Kernel, Embedded, Engineer, linux, kernel, android, qemu, collabora">
		<meta property="og:title" content="Building Android for Qemu with Mesa and Virgil3D" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://memcpy.io/images/2016-08-30_android_qemu.png" />
		<meta property="og:url" content="https://memcpy.io/building-android-for-qemu-with-mesa-and-virgil3d.html" />
		<meta property="og:locale" content="" />
		<meta property="og:site_name" content="memcpy.io" />
		<meta property="article:published_time" content="2016-08-30" />
		<meta property="article:section" content="kernel" />
		<meta property="article:tag" content="linux" />
		<meta property="article:tag" content="kernel" />
		<meta property="article:tag" content="android" />
		<meta property="article:tag" content="qemu" />
		<meta property="article:tag" content="collabora" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:creator" content="@memcpy_io" />
		<meta name="twitter:site" content="@memcpy_io" />
		<meta name="twitter:title" content="Building Android for Qemu with Mesa and Virgil3D" />
		<meta name="twitter:description" content="Running the Linux mainline graphics stack on Android devices is currently not a reality, but this is a viable development environment for improving the situation." />
		<meta name="twitter:image" content="https://memcpy.io/images/2016-08-30_android_qemu.png" />
	</head>
	<body>
		<article id="content" itemscope>
			<header>
				<h1>Building Android for Qemu with Mesa and Virgil3D</h1>
				<p>
				Published <time datetime="2016-08-30" itemprop="datePublished">2016-08-30</time>
				</p>
			</header>
			<p>Running the Linux mainline graphics stack on Android devices is currently not a reality, but this is a viable development environment for improving the situation.</p>
			<p><img alt="Alt text" src="/images/2016-08-30_android_qemu.png" title="Android running on Qemu"></p>
<p>Developing Linux for Android on Qemu allows you to do some things that are
not necessarily possible using the stock emulator.
For my purposes I need access to a GPU and be able to modify the driver, which
is where Virgilrenderer and Qemu comes in handy.</p>
<p>The guide below helps you compile Android and run it on top of Qemu with
Mesa/Virgilrenderer supplying a virtual GPU.
Because of this, the following guide is aimed at Linux hosts.</p>
<p>This guide is based on Rob Herrings <a href="https://github.com/robherring/generic_device/wiki/KConfig-based-Multi-platform-Android-Device-(and-Mesa-graphics)">fantastic guide</a>, but has
been slightly streamlined and had physical hardware support stripped out.</p>
<h2>Install dependencies</h2>
<p>These dependencies were available on Ubuntu 16.04, some alternative packages
might be needed for other distributions.</p>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">apt</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">autoconf</span><span class="w"> </span><span class="n">gcc</span><span class="o">-</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">libaio</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libbluetooth</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libbrlapi</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libbz2</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libcap</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libcap</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libcurl4</span><span class="o">-</span><span class="n">gnutls</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libepoxy</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libfdt</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libgbm</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libgles2</span><span class="o">-</span><span class="n">mesa</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libglib2</span><span class="o">.</span><span class="mi">0</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libgtk</span><span class="o">-</span><span class="mi">3</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libibverbs</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libjpeg8</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">liblzo2</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libncurses5</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libnuma</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">librbd</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">librdmacm</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libsasl2</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libsdl1</span><span class="o">.</span><span class="mi">2</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libsdl2</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libseccomp</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libsnappy</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libssh2</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libspice</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libspice</span><span class="o">-</span><span class="n">server1</span><span class="w"> </span><span class="n">libtool</span><span class="w"> </span><span class="n">libusb</span><span class="o">-</span><span class="mf">1.0</span><span class="o">-</span><span class="mi">0</span><span class="w"> </span><span class="n">libusb</span><span class="o">-</span><span class="mf">1.0</span><span class="o">-</span><span class="mi">0</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libvde</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libvdeplug</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libvte</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libxen</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">valgrind</span><span class="w"> </span><span class="n">xfslibs</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">xutils</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">zlib1g</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">libusbredirhost</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span><span class="n">usbredirserver</span>
</code></pre></div>

<h2>Set up paths</h2>
<p>Naturally all of the paths below are configurable, this is just what I used.</p>
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="n">PROJECT_PATH</span><span class="o">=</span><span class="s2">&quot;/opt/qemu_android&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">VIRGLRENDERER_PATH</span><span class="o">=</span><span class="s2">&quot;${PROJECT_PATH}/virglrenderer&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">QEMU_PATH</span><span class="o">=</span><span class="s2">&quot;${PROJECT_PATH}/qemu&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">LINUX_PATH</span><span class="o">=</span><span class="s2">&quot;${PROJECT_PATH}/linux&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">ANDROID_PATH</span><span class="o">=</span><span class="s2">&quot;${PROJECT_PATH}/android&quot;</span>
<span class="k">export</span><span class="w"> </span><span class="n">ANDROID_TOOLS_PATH</span><span class="o">=</span><span class="s2">&quot;${PROJECT_PATH}/android-tools&quot;</span>
</code></pre></div>

<h2>Virglrenderer</h2>
<p>Virglrenderer creates a virtual 3D GPU, that allows the Qemu guest to use the
graphics capabilities of the host machine.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git://git.freedesktop.org/git/virglrenderer<span class="w"> </span><span class="cp">${</span><span class="n">VIRGLRENDERER_PATH</span><span class="cp">}</span>
cd<span class="w"> </span><span class="cp">${</span><span class="n">VIRGLRENDERER_PATH</span><span class="cp">}</span>
./autogen.sh
make<span class="w"> </span>-j7
sudo<span class="w"> </span>make<span class="w"> </span>install
</code></pre></div>

<h2>Qemu</h2>
<p>Qemu is a full system emulator, and supports a multitude of machine architectures.
We're going to to use x86_64 but also build support for arm64/aarch64.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git://git.qemu-project.org/qemu.git<span class="w"> </span><span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>
mkdir<span class="w"> </span><span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>/build
cd<span class="w"> </span><span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>/build
../configure<span class="w"> </span>--target-list=aarch64-softmmu,x86_64-softmmu<span class="w"> </span>--enable-gtk<span class="w"> </span>--with-gtkabi=3.0<span class="w"> </span>--enable-kvm<span class="w"> </span>--enable-spice<span class="w"> </span>--enable-usb-redir<span class="w"> </span>--enable-libusb
make<span class="w"> </span>-j7
</code></pre></div>

<h2>Linux kernel</h2>
<p>Build trunk of mainline linux kernel.</p>
<p><strong>Important:</strong> The below instructions use upstream/master but during testing of
this guide, <em>https://git.kernel.org/pub/scm/linux/kernel/git/padovan/linux.git</em>
and the <em>fences</em> branch was used due to SW_SYNC not yet being included in upstream.
Inclusion is targeted for <em>v4.9</em>.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git<span class="w"> </span><span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>
cd<span class="w"> </span><span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>
wget<span class="w"> </span>http://memcpy.io/files/2016-08-30/Kconfig<span class="w"> </span>-O<span class="w"> </span><span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>/.config
make<span class="w"> </span>oldconfig
make<span class="w"> </span>-j7
</code></pre></div>

<p><strong>Important:</strong> If you decide not to use the <em>.config</em> linked in this step, a few
Kconfig options need to be set:</p>
<div class="highlight"><pre><span></span><code>CONFIG_ANDROID=y
CONFIG_ANDROID_BINDER_IPC=y
CONFIG_AUDIT=y
CONFIG_HAVE_ARCH_AUDITSYSCALL=y
CONFIG_AUDITSYSCALL=y
CONFIG_AUDIT_WATCH=y
CONFIG_AUDIT_TREE=y
CONFIG_DRM=y
CONFIG_SECURITY_SELINUX=y
CONFIG_SECURITY_SELINUX_BOOTPARAM=y
CONFIG_SECURITY_SELINUX_BOOTPARAM_VALUE=1
CONFIG_SECURITY_SELINUX_DISABLE=y
CONFIG_SECURITY_SELINUX_DEVELOP=y
CONFIG_SECURITY_SELINUX_AVC_STATS=y
CONFIG_SECURITY_SELINUX_CHECKREQPROT_VALUE=0
CONFIG_DEFAULT_SECURITY_SELINUX=y
CONFIG_DEFAULT_SECURITY=&quot;selinux&quot;
CONFIG_VIRTIO_BLK=y
CONFIG_SCSI_VIRTIO=y
CONFIG_VIRTIO_NET=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_HW_RANDOM_VIRTIO=y
CONFIG_DRM_VIRTIO_GPU=y
CONFIG_VIRT_DRIVERS=y
CONFIG_VIRTIO=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_BALLOON=y
CONFIG_VIRTIO_INPUT=y
CONFIG_VIRTIO_MMIO=y
CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES=y
CONFIG_NET_9P=y
CONFIG_NET_9P_VIRTIO=y
CONFIG_SYNC=y
CONFIG_SW_SYNC=y
CONFIG_SYNC_FILE=y
</code></pre></div>

<h2>Android</h2>
<p>Build the Android Open Source Project.</p>
<p><strong>Important:</strong> When running <em>source build/envsetup.sh</em> make sure that you are
using bash. I had issues running <em>lunch</em> using zsh.</p>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span><span class="cp">${</span><span class="n">ANDROID_PATH</span><span class="cp">}</span>
cd<span class="w"> </span><span class="cp">${</span><span class="n">ANDROID_PATH</span><span class="cp">}</span>
repo<span class="w"> </span>init<span class="w"> </span>-u<span class="w"> </span>https://android.googlesource.com/platform/manifest<span class="w"> </span>-b<span class="w"> </span>master
cd<span class="w"> </span>.repo
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/robherring/android_manifest.git<span class="w"> </span>-b<span class="w"> </span>android-6.0<span class="w"> </span>local_manifests
cd<span class="w"> </span>..
repo<span class="w"> </span>sync<span class="w"> </span>-j20
cd<span class="w"> </span>device/linaro/generic
make<span class="w"> </span>defconfig
make<span class="w"> </span>all
cd<span class="w"> </span>../../..
#<span class="w"> </span>The<span class="w"> </span>following<span class="w"> </span>snippet<span class="w"> </span>must<span class="w"> </span>be<span class="w"> </span>run<span class="w"> </span>in<span class="w"> </span>bash
bash
source<span class="w"> </span>build/envsetup.sh
#<span class="w"> </span>Select<span class="w"> </span>linaro_x86_64-userdebug
lunch
make<span class="w"> </span>-j7
#<span class="w"> </span>We<span class="w"> </span>don&#39;t<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>use<span class="w"> </span>bash<span class="w"> </span>any<span class="w"> </span>longer
exit
</code></pre></div>

<p>As of this writing DRM fences related patches by Gustavo Padovan have yet to be included
into AOSP, and therefore have to be included manually until it is upstreamed.
After switching to this branch, the AOSP project has to be rebuilt again.</p>
<div class="highlight"><pre><span></span><code>cd $ANDROID_PATH/system/core/
git remote add padovan git://git.collabora.com/git/user/padovan/android-system-core.git
git fetch padovan
git checkout padovan/master
</code></pre></div>

<h2>mkbootimg</h2>
<p>Fetch the make boot image script. This script later assembles the boot image, <em>boot.img</em>.</p>
<div class="highlight"><pre><span></span><code>git clone https://android.googlesource.com/platform/system/core.git $ANDROID_TOOLS_PATH
</code></pre></div>

<h2>Run Qemu machine</h2>
<p>When running the below script, make sure that the all of the paths from step two
have been exported.</p>
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>http://memcpy.io/files/2016-08-30/boot_android_qemu.sh<span class="w"> </span>-O<span class="w"> </span><span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh
chmod<span class="w"> </span>+x<span class="w"> </span><span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh
<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh<span class="w"> </span>x86_64
</code></pre></div>

<h2>Conclusion</h2>
<p>Hopefully this guide will have enabled you build the required software and run Android on
Qemu with a virtual GPU.
This post has been a part of work undertaken by my employer <a href="http://www.collabora.com">Collabora</a>.</p>
		</article>
		<section id="teaser-section">
			<div id="teaser">
				<p>Tags:
					<a href="https://memcpy.io/tag/linux.html">linux </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/kernel.html">kernel </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/android.html">android </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/qemu.html">qemu </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/collabora.html">collabora </a>
				</p>
			</div>
		</section>
		<footer>
			<div id="footer">
				<p id="notices" class="smcp">
					<a href="/about.html">About</a>
					<span id="breakdot">&middot;</span>
					<a href="/index.html">Blog</a>
					<span id="breakdot">&middot;</span>
					<a href="/talks.html">Talks</a>
					<span id="breakdot">&middot;</span>
					<a href="/contact.html">Contact</a>
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss">GitHub</a>
					<br>
					<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Copyleft</a>
					<span id="breakdot">&middot;</span>
					2023 Robert Foss
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss/memcpy.io">Source</a>
					<br>
					<a href="/"><img src="/logo.svg"></a>
				</p>
			</div>
		</footer>
	</body>
</html>