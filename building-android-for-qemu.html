<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="./theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="./theme/css/pygments.css">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>
	<link rel="icon" type="image/png" href="logo.png" />

	<link href="http://memcpy.io/" type="application/atom+xml" rel="alternate" title="memcpy.io ATOM Feed" />

    <meta property="og:title" content="Building Android for Qemu" />
    <meta property="og:type" content="article" />
    <meta property="og:image" content="http://memcpy.io/images/2016-08-25_ethernet_device_testing.png" />
    <meta property="og:url" content="http://memcpy.io/building-android-for-qemu.html" />
    <meta property="og:description" content="During testing of power management patches for usb ethernet dongles, a script was needed to stress test connecting/disconnecting/reconnecting these devices. Luckily a script like that already exists as a part of the chromiumos project, and can be found here. That script does however not run standalone and requires a remote device (chromebook) to execute on. So I took the liberty of changing it to support local testing. The modified version can be found here. This might come in handy for someone, if not, the script will at least be archived on this site. Install dependencies sudo apt install autoconf gcc-aarch64-linux-gnu libaio-dev libbluetooth-dev libbrlapi-dev libbz2-dev libcap-dev libcap-ng-dev libcurl4-gnutls-dev libepoxy-dev libfdt-dev libgbm-dev libgles2-mesa-dev libglib2.0-dev libibverbs-dev libjpeg8-dev liblzo2-dev libncurses5-dev libnuma-dev librbd-dev librdmacm-dev libsasl2-dev libsdl1.2-dev ..." />
    <meta property="og:locale" content="" />
    <meta property="og:site_name" content="memcpy.io" />
    <meta property="article:published_time" content="2016-08-30" />
    <meta property="article:section" content="kernel" />
    <meta property="article:tag" content="linux" />
    <meta property="article:tag" content="kernel" />
    <meta property="article:tag" content="android" />
    <meta property="article:tag" content="qemu" />

	<title>memcpy.io | Building Android for Qemu</title>
	<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<div id="menu">
			<a href="/">
				<img type="image/png" src="./logo.png" width="155">
			</a>

			<h1>memcpy.io</h1>
			<h2>Projects, hacks and engineering</h2>
			<ul>
					<li><a href="about-me.html">About</a></li>
					<li><a href="contracting.html">Contracting</a></li>
					<li><a href="https://github.com/robertfoss">GitHub</a></li>
					<li><a href="archives.html">Previous posts</a></li>
			</ul>
		</div>
	</section>

	<section id="posts">
	<article class="single">
		<h1 id="title">
			<a href="./building-android-for-qemu.html" rel="bookmark"
				title="Permalink to Building Android for Qemu">Building Android for Qemu</a>
		</h1>
		<abbr class="published" title="2016-08-30T13:05:00+02:00">Tue 30 August 2016</abbr>
		<p><img alt="Alt text" src="images/2016-08-25_ethernet_device_testing.png" title="Screenshot of python script" /></p>
<p>During testing of power management patches for usb ethernet dongles, a script
was needed to stress test connecting/disconnecting/reconnecting these devices.</p>
<p>Luckily a script like that already exists as a part of the chromiumos project,
and can be found <a href="https://chromium.googlesource.com/chromiumos/third_party/autotest/+/HEAD/client/site_tests/network_EthernetStressPlug/network_EthernetStressPlug.py">here</a>.</p>
<p>That script does however not run standalone and requires a remote device
(chromebook) to execute on. So I took the liberty of changing it to support
local testing. The modified version can be found <a href="files/2016-08-25_network_EthernetStressPlug.py">here</a>.</p>
<p>This might come in handy for someone, if not, the script will at least be
archived on this site.</p>
<h2>Install dependencies</h2>
<div class="highlight"><pre>sudo apt install autoconf gcc-aarch64-linux-gnu libaio-dev libbluetooth-dev libbrlapi-dev libbz2-dev libcap-dev libcap-ng-dev libcurl4-gnutls-dev libepoxy-dev libfdt-dev libgbm-dev libgles2-mesa-dev libglib2.0-dev libibverbs-dev libjpeg8-dev liblzo2-dev libncurses5-dev libnuma-dev librbd-dev librdmacm-dev libsasl2-dev libsdl1.2-dev libsdl2-dev libseccomp-dev libsnappy-dev libssh2-1-dev libtool libusb-1.0-0 libusb-1.0-0-dev libvde-dev libvdeplug-dev libvte-2.90-dev libxen-dev valgrind xfslibs-dev xutils-dev zlib1g-dev
</pre></div>


<h2>Set up paths</h2>
<div class="highlight"><pre>export PROJECT_PATH=&quot;/opt/qemu_android&quot;
export QEMU_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/qemu&quot;
export LINUX_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/linux-android&quot;
export ANDROID_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/android&quot;
export ANDROID_TOOLS_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/android-tools&quot;
</pre></div>


<h2>Virglrenderer</h2>
<div class="highlight"><pre>git clone git://git.freedesktop.org/git/virglrenderer
cd virglrenderer
./autogen.sh
make
sudo make install
cd ..
</pre></div>


<h2>Qemu</h2>
<div class="highlight"><pre><span class="x">git clone git://git.qemu-project.org/qemu.git </span><span class="p">$</span><span class="nv">QEMU_PATH</span><span class="x"></span>
<span class="x">mkdir </span><span class="p">$</span><span class="nv">QEMU_PATH</span><span class="x">/build</span>
<span class="x">cd </span><span class="p">$</span><span class="nv">QEMU_PATH</span><span class="x">/build</span>
<span class="x">../configure --target-list=aarch64-softmmu,x86_64-softmmu --enable-gtk --with-gtkabi=3.0 --enable-kvm</span>
<span class="x">make -j</span>
<span class="x">cd ../..</span>
</pre></div>


<h2>Linux kernel</h2>
<div class="highlight"><pre><span class="x">git clone http://git.linaro.org/people/rob.herring/linux.git </span><span class="p">$</span><span class="nv">LINUX_PATH</span><span class="x"></span>
<span class="x">cd </span><span class="p">$</span><span class="nv">LINUX_PATH</span><span class="x"></span>
<span class="x">git checkout android-4.4</span>
<span class="x">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- ranchu_defconfig</span>
<span class="x">make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j</span>
<span class="x">cd ..</span>
</pre></div>


<h2>Android</h2>
<div class="highlight"><pre><span class="x">mkdir </span><span class="p">$</span><span class="nv">ANDROID_PATH</span><span class="x"></span>
<span class="x">cd </span><span class="p">$</span><span class="nv">ANDROID_PATH</span><span class="x"></span>
<span class="x">repo init -u https://android.googlesource.com/platform/manifest -b master</span>
<span class="x">git clone https://github.com/robherring/android_manifest.git -b android-6.0 local_manifests</span>
<span class="x">cd ..</span>
<span class="x">repo sync -j</span>
<span class="x">cd device/linaro/generic</span>
<span class="x">make defconfig</span>
<span class="x">make all</span>
<span class="x">cd ../../..</span>
<span class="x">source build/envsetup.sh</span>
<span class="err">#</span><span class="x"> Select linaro_arm64-userdebug or linaro_x86_64-userdebug</span>
<span class="x">lunch</span>
<span class="x">make -j</span>
<span class="x">cd ..</span>
</pre></div>


<h2>mkbootimg</h2>
<div class="highlight"><pre><span class="x">git clone https://android.googlesource.com/platform/system/core.git </span><span class="p">$</span><span class="nv">ANDROID_TOOLS_PATH</span><span class="x"></span>
<span class="p">$</span><span class="nv">ANDROID_TOOLS_PATH</span><span class="x">/mkbootimg/mkbootimg --kernel </span><span class="p">$</span><span class="nv">LINUX_PATH</span><span class="x">/arch/arm64/boot/Image --ramdisk </span><span class="p">$</span><span class="nv">ANDROID_PATH</span><span class="x">/out/target/product/linaro_arm64/ramdisk.img --output boot-db410c.img --dt dt.img --pagesize 2048 --base 0x80000000 --cmdline &#39;rw console=ttyMSM0,115200n8&#39;</span>
</pre></div>


<h2>Run Qemu machine</h2>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="highlight"><pre><span class="ch">#!/bin/bash</span>

<span class="nb">set</span> -e

<span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$A</span><span class="s2">NDROID_PATH/out/host/linux-x86/bin/:</span>$<span class="s2">PATH&quot;</span>


<span class="nv">ARCH</span><span class="o">=</span><span class="s2">&quot;arm64&quot;</span>
<span class="nv">QEMU_ARCH</span><span class="o">=</span><span class="nv">$A</span>RCH

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$A</span><span class="s2">RCH&quot;</span> in
arm<span class="o">)</span>
    <span class="nv">QEMU_OPTS</span><span class="o">=</span><span class="s2">&quot;-cpu cortex-a15 -machine type=virt&quot;</span>
    <span class="nv">KERNEL_CMDLINE</span><span class="o">=</span><span class="s1">&#39;console=ttyAMA0,38400 earlycon=pl011,0x09000000 debug nosmp drm.debug=0 rootwait androidboot.selinux=permissive&#39;</span>
    <span class="nv">KERNEL</span><span class="o">=</span>/home/rob/proj/git/linux-2.6/.build-arm/arch/arm/boot/zImage
    <span class="p">;;</span>
arm64<span class="o">)</span>
    <span class="nv">QEMU_ARCH</span><span class="o">=</span><span class="s2">&quot;aarch64&quot;</span>
    <span class="nv">QEMU_OPTS</span><span class="o">=</span><span class="s2">&quot;-cpu cortex-a57 -machine type=virt&quot;</span>
    <span class="nv">KERNEL_CMDLINE</span><span class="o">=</span><span class="s1">&#39;console=ttyAMA0,38400 earlycon=pl011,0x09000000 nosmp drm.debug=0 rootwait rootdelay=5 androidboot.selinux=permissive&#39;</span>
    <span class="nv">KERNEL</span><span class="o">=</span>/home/rob/proj/git/linux-2.6/.build-arm64/arch/arm64/boot/Image
    <span class="p">;;</span>
x86_64<span class="o">)</span>
    <span class="nv">KERNEL</span><span class="o">=</span>/home/padovan/p/linux-trees/linux/arch/x86/boot/bzImage
    <span class="nv">QEMU_OPTS</span><span class="o">=</span><span class="s2">&quot;-enable-kvm -smp 2&quot;</span>
    <span class="nv">KERNEL_CMDLINE</span><span class="o">=</span><span class="s1">&#39;console=tty0 console=ttyS0 debug drm.debug=0 androidboot.selinux=permissive&#39;</span>
    <span class="p">;;</span>
x86<span class="o">)</span>
    <span class="nv">QEMU_ARCH</span><span class="o">=</span><span class="s2">&quot;x86_64&quot;</span>
    <span class="nv">KERNEL</span><span class="o">=</span>/home/padovan/p/linux-trees/linux/arch/x86/boot/bzImage
    <span class="nv">QEMU_OPTS</span><span class="o">=</span><span class="s2">&quot;-enable-kvm -smp 2&quot;</span>
    <span class="nv">KERNEL_CMDLINE</span><span class="o">=</span><span class="s1">&#39;console=tty0 console=ttyS0 debug  drm.debug=0 androidboot.selinux=permissive&#39;</span>
    <span class="p">;;</span>
<span class="k">esac</span>

<span class="nv">ANDROID_IMAGE_PATH</span><span class="o">=</span>/home/padovan/p/aosp/out/target/product/linaro_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>

<span class="k">if</span> <span class="o">[</span> ! -f system_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw -o <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/system.img -nt system_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    simg2img <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/system.img system_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> ! -f cache_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw -o <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/cache.img -nt cache_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    simg2img <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/cache.img cache_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> ! -f userdata_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw -o <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/userdata.img -nt userdata_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    simg2img <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/userdata.img userdata_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw
<span class="k">fi</span>

/home/padovan/p/qemu/<span class="si">${</span><span class="nv">QEMU_ARCH</span><span class="si">}</span>-softmmu/qemu-system-<span class="si">${</span><span class="nv">QEMU_ARCH</span><span class="si">}</span> <span class="se">\</span>
    <span class="si">${</span><span class="nv">QEMU_OPTS</span><span class="si">}</span> <span class="se">\</span>
    -append <span class="s2">&quot;</span><span class="si">${</span><span class="nv">KERNEL_CMDLINE</span><span class="si">}</span><span class="s2">&quot;</span> <span class="se">\</span>
    -m <span class="m">1024</span> <span class="se">\</span>
    -serial mon:stdio <span class="se">\</span>
    -kernel $KERNEL <span class="se">\</span>
    -initrd <span class="si">${</span><span class="nv">ANDROID_IMAGE_PATH</span><span class="si">}</span>/ramdisk.img <span class="se">\</span>
    -drive <span class="nv">index</span><span class="o">=</span>0,if<span class="o">=</span>none,id<span class="o">=</span>system,file<span class="o">=</span>system_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="se">\</span>
    -device virtio-blk-pci,drive<span class="o">=</span>system <span class="se">\</span>
    -drive <span class="nv">index</span><span class="o">=</span>1,if<span class="o">=</span>none,id<span class="o">=</span>cache,file<span class="o">=</span>cache_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="se">\</span>
    -device virtio-blk-pci,drive<span class="o">=</span>cache <span class="se">\</span>
    -drive <span class="nv">index</span><span class="o">=</span>2,if<span class="o">=</span>none,id<span class="o">=</span>userdata,file<span class="o">=</span>userdata_<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>.raw <span class="se">\</span>
    -device virtio-blk-pci,drive<span class="o">=</span>userdata <span class="se">\</span>
    -netdev user,id<span class="o">=</span>mynet,hostfwd<span class="o">=</span>tcp::5550-:5555 -device virtio-net-pci,netdev<span class="o">=</span>mynet <span class="se">\</span>
    -device virtio-gpu-pci,virgl -display gtk,gl<span class="o">=</span>on <span class="se">\</span>
    -device virtio-mouse-pci -device virtio-keyboard-pci <span class="se">\</span>
    -device nec-usb-xhci,id<span class="o">=</span>xhci                    <span class="se">\</span>
    -device sdhci-pci <span class="se">\</span>
    -d guest_errors <span class="se">\</span>
    -nodefaults <span class="se">\</span>
    <span class="nv">$*</span>
</pre></div>
</td></tr></table>

		<div id="article_meta">
				Category:
					<a href="./category/kernel.html">kernel</a>
				<br />Tags:
					<a href="./tag/linux.html">linux</a>
					<a href="./tag/kernel.html">kernel</a>
					<a href="./tag/android.html">android</a>
					<a href="./tag/qemu.html">qemu</a>
		</div>
	</article>

	<footer>
		<a href="./" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>


	</section>

</body>
</html>