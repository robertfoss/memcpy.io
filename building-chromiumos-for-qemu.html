<!DOCTYPE html>
<html>
	<head>
		<title>memcpy.io | Building ChromiumOS for Qemu</title>
		<link rel="icon" type="image/png" href="/logo.png" />
		<link rel="stylesheet" type="text/css" href="/theme/css/fonts.css">
		<link rel="stylesheet" type="text/css" href="/theme/css/math.css">
        <link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="/theme/css/page.css">
		<meta charset="utf-8">
		<meta name="robots" content="index,follow">
		<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- TODO: is this still required in 2015? -->
		<meta name="description" content="So let&#39;s start off by covering how ChromiumOS relates to ChromeOS. The ChromiumOS project is essentially ChromeOS minus branding and some packages for things like the media digital restrictions management. But on the whole, almost everything is there, and the pieces that aren&#39;t, you don&#39;t need. ChromiumOS Depot tools In order to check out ChromiumOS and other large Google projects, you&#39;ll need depot tools. git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git export PATH=$PATH:$(PWD)/depot_tools Maybe you&#39;d want to add the PATH export to your .bashrc. Building ChromiumOS mkdir chromiumos cd chromiumos repo init -u https://chromium.googlesource.com/chromiumos/manifest.git --repo-url https://chromium.googlesource.com/external/repo.git [-g minilayout] repo sync -j75 cros_sdk export BOARD=amd64-generic ./setup_board --board â€¦">
		<meta name="author" content="Robert Foss">
		<meta name="keywords" content="Robert Foss memcpy Robert Foss, Open Source, Software, Linux, Embedded, Engineer, linux, kernel, chromeos, chromiumos, chromium, qemu, ssh, collabora">
		<meta property="og:title" content="Building ChromiumOS for Qemu" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://memcpy.io/images/2017-11-28_chromeos_qemu.png" />
		<meta property="og:url" content="https://memcpy.io/building-chromiumos-for-qemu.html" />
		<meta property="og:locale" content="" />
		<meta property="og:site_name" content="memcpy.io" />
		<meta property="article:published_time" content="2017-11-28" />
		<meta property="article:section" content="kernel" />
		<meta property="article:tag" content="linux" />
		<meta property="article:tag" content="kernel" />
		<meta property="article:tag" content="chromeos" />
		<meta property="article:tag" content="chromiumos" />
		<meta property="article:tag" content="chromium" />
		<meta property="article:tag" content="qemu" />
		<meta property="article:tag" content="ssh" />
		<meta property="article:tag" content="collabora" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:creator" content="@memcpy_io" />
		<meta name="twitter:site" content="@memcpy_io" />
		<meta name="twitter:title" content="Building ChromiumOS for Qemu" />
		<meta name="twitter:description" content="Getting ChromiumOS building is reasonably easy, but running it under Qemu requires some work." />
		<meta name="twitter:image" content="https://memcpy.io/images/2017-11-28_chromeos_qemu.png" />
	</head>
	<body>
		<article id="content" itemscope>
			<header>
				<h1>Building ChromiumOS for Qemu</h1>
				<p>
				Published <time datetime="2017-11-28" itemprop="datePublished">2017-11-28</time>
				</p>
			</header>
			<p>Getting ChromiumOS building is reasonably easy, but running it under Qemu requires some work.</p>
			<p><img alt="Alt text" src="/images/2017-11-28_chromeos_qemu.png" title="ChromiumOS running on Qemu"></p>
<p>So let's start off by covering how ChromiumOS relates to ChromeOS. The
ChromiumOS project is essentially ChromeOS minus branding and some
packages for things like the media digital restrictions management.</p>
<p>But on the whole, almost everything is there, and the pieces that aren't,
you don't <em>need</em>.</p>
<h2>ChromiumOS</h2>
<h3>Depot tools</h3>
<p>In order to check out ChromiumOS and other large Google projects,
you'll need depot tools.</p>
<div class="highlight"><pre><span></span><span class="nf">git clone https</span><span class="o">:</span>//<span class="n">chromium</span>.<span class="n">googlesource</span>.<span class="n">com</span>/<span class="n">chromium</span>/<span class="n">tools</span>/<span class="n">depot_tools</span>.<span class="n">git</span>
<span class="k">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="k">$(</span>PWD<span class="k">)</span>/depot_tools
</pre></div>


<p>Maybe you'd want to add the PATH export to your .bashrc.</p>
<h3>Building ChromiumOS</h3>
<div class="highlight"><pre><span></span>mkdir chromiumos
cd chromiumos
repo init -u https://chromium.googlesource.com/chromiumos/manifest.git --repo-url https://chromium.googlesource.com/external/repo.git [-g minilayout]
repo sync -j75
cros_sdk
export BOARD=amd64-generic
./setup_board --board=<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span>
./build_packages --board=<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span>
./build_image --board=<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span> --boot_args &quot;earlyprintk=serial,keep console=tty0&quot; --noenable_rootfs_verification test
./image_to_vm.sh --board=<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span> --test_image
</pre></div>


<h3>How to (not) boot ChromiumOS</h3>
<p>So, this is a command baked into ChromiumOS using the <code>cros_start_vm</code> command,
but at least on my machine it does not seem to boot properly.
I have as of yet not been able to get any graphical output (over VNC).</p>
<div class="highlight"><pre><span></span>cros_sdk
./bin/cros_start_vm --image_path=../build/images/<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span>/latest/chromiumos_qemu_image.bin --board=<span class="cp">${</span><span class="n">BOARD</span><span class="cp">}</span>
</pre></div>


<h2>Running Qemu ourselves</h2>
<p>So if the intended tools don't work, we'll just have to roll up our sleeves
and do it ourselves. This is how I got ChromiumOS booting.</p>
<h3>Install build dependencies</h3>
<p>These dependencies were available on Ubuntu 17.10, some alternative packages
might be needed for <em>your</em> distributions.</p>
<div class="highlight"><pre><span></span>sudo apt install autoconf libaio-dev libbluetooth-dev libbrlapi-dev libbz2-dev libcap-dev libcap-ng-dev libcurl4-gnutls-dev libepoxy-dev libfdt-dev libgbm-dev libgles2-mesa-dev libglib2.0-dev libgtk-3-dev libibverbs-dev libjpeg8-dev liblzo2-dev libncurses5-dev libnuma-dev librbd-dev librdmacm-dev libsasl2-dev libsdl1.2-dev libsdl2-dev libseccomp-dev libsnappy-dev libssh2-1-dev libspice-server-dev libspice-server1 libtool libusb-1.0-0 libusb-1.0-0-dev libvde-dev libvdeplug-dev libvte-dev libxen-dev valgrind xfslibs-dev xutils-dev zlib1g-dev libusbredirhost-dev usbredirserver
</pre></div>


<h3>Virglrenderer</h3>
<p>Virglrenderer creates a virtual 3D GPU, that allows the Qemu guest to use the
graphics capabilities of the host machine.</p>
<p>This step is optional, but allows for hardware accelerated OpenGL support on
the guest system.
If you don't want to use Virgl, remove it from the Qemu configure step and
the Qemu runtime flags.</p>
<div class="highlight"><pre><span></span>git clone git://git.freedesktop.org/git/virglrenderer
cd virglrenderer
./autogen.sh
make -j7
sudo make install
</pre></div>


<h3>Qemu</h3>
<p>Qemu is a full system emulator, and supports a multitude of machine architectures.
We're going to to use <em>x86_64</em>.</p>
<div class="highlight"><pre><span></span>git clone git://git.qemu-project.org/qemu.git
mkdir -p qemu/build
cd qemu/build
../configure --target-list=x86_64-softmmu --enable-gtk --with-gtkabi=3.0 --enable-kvm --enable-spice --enable-usb-redir --enable-libusb --enable-virglrenderer --enable-opengl
make -j7
sudo make install
</pre></div>


<h3>Run image</h3>
<p>Now you can boot the image using Qemu.</p>
<p>Note that running Qemu with the virtio options requires that your host machine
is running a Linux kernel which was built with the kconfig options <code>CONFIG_DRM_VIRTIO</code>,
<code>CONFIG_VIRT_DRIVERS</code> and <code>CONFIG_VIRTIO_XXXX</code>.</p>
<div class="highlight"><pre><span></span>cd chromiumos
/usr/local/bin/qemu-system-x86_64 \
    -enable-kvm \
    -m 2G \
    -smp 4 \
    -hda src/build/images/amd64-generic/latest/chromiumos_qemu_image.bin \
    -vga virtio \
    -net nic,model=virtio \
    -net user,hostfwd=tcp:127.0.0.1:9222-:22 \
    -usb -usbdevice keyboard \
    -usbdevice mouse \
    -device virtio-gpu-pci,virgl \
    -display gtk,gl=on
</pre></div>


<h2>Conclusion</h2>
<p>Hopefully this guide will have helped you to build all of the software needed to
boot your very own ChromiumOS.</p>
<p>This post has been a part of work undertaken by my employer <a href="http://www.collabora.com">Collabora</a>.</p>
		</article>
		<section id="teaser-section">
			<div id="teaser">
				<p>Tags:
					<a href="./tag/linux.html">linux </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/kernel.html">kernel </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/chromeos.html">chromeos </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/chromiumos.html">chromiumos </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/chromium.html">chromium </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/qemu.html">qemu </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/ssh.html">ssh </a>
					<span id="breakdot">&middot; </span>
					<a href="./tag/collabora.html">collabora </a>
				</p>
			</div>
		</section>
		<footer>
			<div id="footer">
				<p id="notices" class="smcp">
					<a href="/about.html">About</a>
					<span id="breakdot">&middot;</span>
					<a href="/index.html">Blog</a>
					<span id="breakdot">&middot;</span>
					<a href="/talks.html">Talks</a>
					<span id="breakdot">&middot;</span>
					<a href="/contact.html">Contact</a>
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss">GitHub</a>
					<br>
					<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Copyleft</a>
					<span id="breakdot">&middot;</span>
					2020 Robert Foss
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss/memcpy.io">Source</a>
					<br>
					<a href="/"><img src="/logo.png"></a>
				</p>
			</div>
		</footer>
	</body>
</html>