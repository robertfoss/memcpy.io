<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="../theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="../theme/css/pygments.css">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:800,400,300|Inconsolata' rel='stylesheet' type='text/css'>
	<link rel="icon" type="image/png" href="logo.png" />

	<link href="http://memcpy.io/" type="application/atom+xml" rel="alternate" title="memcpy.io ATOM Feed" />


	<title>memcpy.io | Building Android for Qemu</title>
	<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<div id="menu">
			<a href="/">
				<img type="image/png" src="../logo.png" width="155">
			</a>

			<h1>memcpy.io</h1>
			<h2>Projects, hacks and engineering</h2>
			<ul>
					<li><a href="about-me.html">About</a></li>
					<li><a href="contracting.html">Contracting</a></li>
					<li><a href="https://github.com/robertfoss">GitHub</a></li>
					<li><a href="archives.html">Previous posts</a></li>
			</ul>
		</div>
	</section>

	<section id="posts">
	<article class="single">
		<h1 id="title">
			<a href="../drafts/building-android-for-qemu.html" rel="bookmark"
				title="Permalink to Building Android for Qemu">Building Android for Qemu</a>
		</h1>
		<abbr class="published" title="2016-08-30T15:22:00+02:00">Tue 30 August 2016</abbr>
		<p><img alt="Alt text" src="images/2016_08_30_android_qemu.png" title="Android running on Qemu" /></p>
<p>Developing Linux for Android on Qemu allows you to do some things that are
not necessarily possible using the stock emulator.
For my purposes I need access to a GPU and be able to modify the driver, which
is where Virgilrenderer and Qemu comes in handy.</p>
<p>The guide below helps you compile Android and run it on top of Qemu with
Mesa/Virgilrenderer supplying a virtual GPU.
Because of this, the following guide is aimed at Linux hosts.</p>
<p>This guide is based on Rob Herrings <a href="https://github.com/robherring/generic_device/wiki/KConfig-based-Multi-platform-Android-Device-(and-Mesa-graphics)">fantastic guide</a>, but has
been slightly streamlined and had physical hardware support stripped out.</p>
<h2>Install dependencies</h2>
<p>These dependencies were available on Ubuntu 16.04, some alternative packages
might be needed for other distributions.</p>
<div class="highlight"><pre>sudo apt install autoconf gcc-aarch64-linux-gnu libaio-dev libbluetooth-dev libbrlapi-dev libbz2-dev libcap-dev libcap-ng-dev libcurl4-gnutls-dev libepoxy-dev libfdt-dev libgbm-dev libgles2-mesa-dev libglib2.0-dev libibverbs-dev libjpeg8-dev liblzo2-dev libncurses5-dev libnuma-dev librbd-dev librdmacm-dev libsasl2-dev libsdl1.2-dev libsdl2-dev libseccomp-dev libsnappy-dev libssh2-1-dev libtool libusb-1.0-0 libusb-1.0-0-dev libvde-dev libvdeplug-dev libvte-2.90-dev libxen-dev valgrind xfslibs-dev xutils-dev zlib1g-dev
</pre></div>


<h2>Set up paths</h2>
<p>Naturally all of the paths below are configurable, this is just what I used.</p>
<div class="highlight"><pre>export PROJECT_PATH=&quot;/opt/qemu_android&quot;
export VIRGLRENDERER_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/virglrenderer&quot;
export QEMU_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/qemu&quot;
export LINUX_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/linux&quot;
export ANDROID_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/android&quot;
export ANDROID_TOOLS_PATH=&quot;<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/android-tools&quot;
</pre></div>


<h2>Virglrenderer</h2>
<p>Virglrenderer creates a virtual 3D GPU, that allows the Qemu guest to use the
graphics capabilities of the host machine.</p>
<div class="highlight"><pre>git clone git://git.freedesktop.org/git/virglrenderer <span class="cp">${</span><span class="n">VIRGLRENDERER_PATH</span><span class="cp">}</span>
cd <span class="cp">${</span><span class="n">VIRGLRENDERER_PATH</span><span class="cp">}</span>
./autogen.sh
make
sudo make install
</pre></div>


<h2>Qemu</h2>
<p>Qemu is a full system emulator, and supports a multitude of machine architectures.
We're going to to use x86_64 but also build support for arm64/aarch64.</p>
<div class="highlight"><pre>git clone git://git.qemu-project.org/qemu.git <span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>
mkdir <span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>/build
cd <span class="cp">${</span><span class="n">QEMU_PATH</span><span class="cp">}</span>/build
../configure --target-list=aarch64-softmmu,x86_64-softmmu --enable-gtk --with-gtkabi=3.0 --enable-kvm
make -j
</pre></div>


<h2>Linux kernel</h2>
<p>Build trunk of mainline linux kernel.</p>
<p><strong>Important:</strong> If not building for x86_64, make sure that SELinux is enabled.
x86_64 has SELinux enabled by default and requires no further configuration.</p>
<p><strong>Important 2:</strong> Virtio has to be enabled in the kernel you're building for Android.
The <em>.config</em> file provided below has CONFIG_VIRTIO_XXX=y for all CONFIG_VIRTIO_XXX
settings.</p>
<div class="highlight"><pre>git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git <span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>
cd <span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>
wget http://memcpy.io/files/2016-08-30/.config -O <span class="cp">${</span><span class="n">LINUX_PATH</span><span class="cp">}</span>/.config
make oldconfig
make -j
</pre></div>


<h2>Android</h2>
<p>Build the Android Open Source Project.</p>
<p><strong>Important:</strong> When running <em>source build/envsetup.sh</em> make sure that you are
using bash. I had issues running <em>lunch</em> using zsh.</p>
<div class="highlight"><pre>mkdir <span class="cp">${</span><span class="n">ANDROID_PATH</span><span class="cp">}</span>
cd <span class="cp">${</span><span class="n">ANDROID_PATH</span><span class="cp">}</span>
repo init -u https://android.googlesource.com/platform/manifest -b master
cd .repo
git clone https://github.com/robherring/android_manifest.git -b android-6.0 local_manifests
cd ..
repo sync -j
cd device/linaro/generic
make defconfig
make all
cd ../../..
# The following snippet must be run in bash
bash
source build/envsetup.sh
# Select linaro_x86_64-userdebug
lunch
make -j
# We don&#39;t need to use bash any longer
exit
</pre></div>


<h2>mkbootimg</h2>
<p>Fetch the make boot image script. This script later assembles the boot image, <em>boot.img</em>.</p>
<div class="highlight"><pre><span class="x">git clone https://android.googlesource.com/platform/system/core.git </span><span class="p">$</span><span class="nv">ANDROID_TOOLS_PATH</span><span class="x"></span>
</pre></div>


<h2>Run Qemu machine</h2>
<p>When running the below script, make sure that the all of the paths from step two
have been exported.</p>
<div class="highlight"><pre>wget http://memcpy.io/files/2016-08-30/boot_android_qemu.sh -O <span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh
chmod +x <span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh
<span class="cp">${</span><span class="n">PROJECT_PATH</span><span class="cp">}</span>/boot_android_qemu.sh x86_64
</pre></div>


<h2>Conclusion</h2>
<p>Hopefully this guide will have enabled you build the required software and run Android on
Qemu with a virtual GPU.
The post was has been a part of work undertaken by my employer <a href="http://www.collabora.com">Collabora</a>.</p>

		<div id="article_meta">
				Category:
					<a href="../category/kernel.html">kernel</a>
				<br />Tags:
					<a href="../tag/linux.html">linux</a>
					<a href="../tag/kernel.html">kernel</a>
					<a href="../tag/android.html">android</a>
					<a href="../tag/qemu.html">qemu</a>
					<a href="../tag/collabora.html">collabora</a>
		</div>
	</article>

	<footer>
		<a href="../" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>


	</section>

</body>
</html>