<!DOCTYPE html>
<html>
	<head>
		<title>memcpy.io | Virtualizing GPU Access</title>
		<link rel="icon" type="image/png" href="/logo.png" />
		<link rel="stylesheet" type="text/css" href="/theme/css/fonts.css">
		<link rel="stylesheet" type="text/css" href="/theme/css/math.css">
        <link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="/theme/css/page.css">
		<link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="memcpy.io atom feed" />
		<link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="memcpy.io RSS feed" />
		<meta charset="utf-8">
		<meta name="robots" content="index,follow">
		<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- TODO: is this still required in 2015? -->
		<meta name="description" content="For the past few years a clear trend of containerization of applications and services has emerged. Having binaries containerized is beneficial in a number of ways. It both improves portability and strengthens security, and if done properly the performance penalty can be low. In order to further improve security containers are commonly run in virtualized environments. This provides some new challenges in terms of supporting the accelerated graphics usecase. Trying it out Environment First of all, let&#39;s have a look at the development environment. When doing graphical development I find it quite helpful to set up a parallel graphics stack in order to not pollute or depend on the stack of the host machine more than we have to. function add_export_env { local VAR=&#34;$1&#34; shift â€¦">
		<meta name="author" content="Robert Foss">
		<meta name="keywords" content="Robert Foss memcpy Robert Foss, Open Source, Software, Linux, Embedded, Engineer, linux, gpu, virtualization, virgl, virglrenderer, opengl, vulkan, gles, collabora">
	</head>
	<body>
		<article id="content" itemscope>
			<header>
				<h1>Virtualizing GPU Access</h1>
				<p>
				Published <time datetime="2018-02-09" itemprop="datePublished">2018-02-09</time>
				</p>
			</header>
			<p>Virtualized GPU access is becoming commonly in the containerized and virtualized application space. Let's have a look at why and how.</p>
			<p><a href="/images/2018-02-09_virgl.svg"><img alt="Alt text" src="/images/2018-02-09_virgl.svg" title="Virtualized OpenGL Stack">
</a>
For the past few years a clear trend of containerization of applications
and services has emerged. Having binaries containerized is beneficial
in a number of ways. It both improves portability and strengthens security,
and if done properly the performance penalty can be low.</p>
<p>In order to further improve security containers are commonly run in
virtualized environments. This provides some new challenges in terms
of supporting the accelerated graphics usecase.</p>
<h2>Trying it out</h2>
<h3>Environment</h3>
<p>First of all, let's have a look at the development environment.
When doing graphical development I find it quite helpful to set
up a parallel graphics stack in order to not pollute or depend on
the stack of the host machine more than we have to.</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">add_export_env</span> <span class="p">{</span>
  <span class="nx">local</span> <span class="nx">VAR</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
  <span class="nx">shift</span>
  <span class="nx">local</span> <span class="nx">VAL</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="nb">eval</span> <span class="nx">echo</span> <span class="s2">&quot;\$$VAR&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">[</span> <span class="s2">&quot;$VAL&quot;</span> <span class="p">];</span> <span class="nx">then</span>
    <span class="nx">VAL</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="nx">concatenate_colon</span> <span class="s2">&quot;$@&quot;</span> <span class="s2">&quot;$VAL&quot;</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nx">VAL</span><span class="o">=</span><span class="nx">$</span><span class="p">(</span><span class="nx">concatenate_colon</span> <span class="s2">&quot;$@&quot;</span><span class="p">);</span>
  <span class="nx">fi</span>
  <span class="nb">eval</span> <span class="s2">&quot;export $VAR=\&quot;$VAL\&quot;&quot;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">prefix_setup</span> <span class="p">{</span>
  <span class="nx">local</span> <span class="nx">PFX</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>

  <span class="nx">add_export_env</span> <span class="nx">PATH</span> <span class="s2">&quot;$PFX/bin&quot;</span>
  <span class="nx">add_export_env</span> <span class="nx">LD_LIBRARY_PATH</span> <span class="s2">&quot;$PFX/lib&quot;</span>
  <span class="nx">add_export_env</span> <span class="nx">PKG_CONFIG_PATH</span> <span class="s2">&quot;$PFX/lib/pkgconfig/&quot;</span> <span class="s2">&quot;$PFX/share/pkgconfig/&quot;</span>
  <span class="nx">add_export_env</span> <span class="nx">MANPATH</span> <span class="s2">&quot;$PFX/share/man&quot;</span>
  <span class="kr">export</span> <span class="nx">ACLOCAL_PATH</span><span class="o">=</span><span class="s2">&quot;$PFX/share/aclocal&quot;</span>
  <span class="nx">mkdir</span> <span class="o">-</span><span class="nx">p</span> <span class="s2">&quot;$ACLOCAL_PATH&quot;</span>
  <span class="kr">export</span> <span class="nx">ACLOCAL</span><span class="o">=</span><span class="s2">&quot;aclocal -I $ACLOCAL_PATH&quot;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">projectshell</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s2">&quot;$1&quot;</span> <span class="k">in</span>
    <span class="nx">virgl</span> <span class="o">|</span> <span class="nx">virglrenderer</span><span class="p">)</span>
        <span class="kr">export</span> <span class="nx">ALT_LOCAL</span><span class="o">=</span><span class="s2">&quot;/opt/local/virgl&quot;</span>
        <span class="nx">mkdir</span> <span class="o">-</span><span class="nx">p</span> <span class="s2">&quot;$ALT_LOCAL&quot;</span>
        <span class="nx">prefix_setup</span> <span class="s2">&quot;$ALT_LOCAL&quot;</span>
        <span class="p">;;</span>
<span class="p">}</span>
</pre></div>


<p>So the above snippet is something that I would put in my <code>.bashrc</code> or <code>.zshrc</code>.</p>
<p>To enter the environment I simply type <code>projectshell virgl</code>.</p>
<h3>Build libepoxy</h3>
<p>libepoxy is a library for managing OpenGL function pointers for you.
And it is a dependency of virglrenderer, which we'll get to in a bit.</p>
<div class="highlight"><pre><span></span>git clone https://github.com/anholt/libepoxy.git
./autogen.sh --prefix=$ALT_LOCAL
make -j$(nproc --ignore=1)
make install
</pre></div>


<h3>Build libpciaccess</h3>
<div class="highlight"><pre><span></span>git clone git://git.freedesktop.org/git/xorg/lib/libpciaccess
./autogen.sh --prefix=$ALT_LOCAL
make -j$(nproc --ignore=1)
make install
</pre></div>


<h3>Build Mesa</h3>
<div class="highlight"><pre><span></span>git clone https://anongit.freedesktop.org/git/mesa/mesa.git
./autogen.sh --prefix=$ALT_LOCAL
make -j$(nproc --ignore=1)
make install
</pre></div>


<h2>Conclusion</h2>
<p>Hopefully this guide will have helped you to build all of the software needed to
build your very own virglrenderer enabled graphics stack.</p>
<p>This post has been a part of work undertaken by my employer <a href="http://www.collabora.com">Collabora</a>.</p>
		</article>
		<section id="teaser-section">
			<div id="teaser">
				<p>Tags:
					<a href="../tag/linux.html">linux </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/gpu.html">gpu </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/virtualization.html">virtualization </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/virgl.html">virgl </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/virglrenderer.html">virglrenderer </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/opengl.html">opengl </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/vulkan.html">vulkan </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/gles.html">gles </a>
					<span id="breakdot">&middot; </span>
					<a href="../tag/collabora.html">collabora </a>
				</p>
			</div>
		</section>
		<footer>
			<div id="footer">
				<p id="notices" class="smcp">
					<a href="/about.html">About</a>
					<span id="breakdot">&middot;</span>
					<a href="/index.html">Blog</a>
					<span id="breakdot">&middot;</span>
					<a href="/talks.html">Talks</a>
					<span id="breakdot">&middot;</span>
					<a href="/contact.html">Contact</a>
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss">GitHub</a>
					<br>
					<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Copyleft</a>
					<span id="breakdot">&middot;</span>
					2018 Robert Foss
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss/memcpy.io">Source</a>
					<br>
					<a href="/"><img src="/logo.png"></a>
				</p>
			</div>
		</footer>
	</body>
</html>