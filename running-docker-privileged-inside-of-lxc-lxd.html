<!DOCTYPE html>
<html>
	<head>
		<title>memcpy.io | Running Docker privileged inside of LXC / LXD</title>
		<script src="https://cdn.nocodeflow.net/tools/geoblock.js"></script>
		<link rel="icon" type="image/png" href="/favicon.png" />
		<link rel="stylesheet" type="text/css" href="/theme/css/fonts.css">
		<link rel="stylesheet" type="text/css" href="/theme/css/math.css">
		<link href="https://fonts.googleapis.com/css?family=Maven+Pro" rel="stylesheet">
		<link rel="canonical" href="https://memcpy.io/running-docker-privileged-inside-of-lxc-lxd.html">
		<link rel="stylesheet" type="text/css" href="/theme/css/page.css">
		<link href="https://memcpy.io/feeds/all.rss.xml" type="application/atom+xml" rel="alternate" title="memcpy.io ATOM Feed" />
		<link href="https://memcpy.io/feeds/all.atom.xml" type="application/rss+xml" rel="alternate" title="memcpy.io RSS Feed" />
		<meta name="google-site-verification" content="M7TRHJxGB04WWoywNbib8VC7rcbyjs7aMI2Bnkh6XqA" />
		<meta charset="utf-8">
		<meta name="robots" content="index,follow">
		<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- TODO: is this still required in 2015? -->
		<meta name="description" content="The architecture is a bit of container matroska, but what we&#39;re trying to achieve is running Docker privileged inside of a LXC container on a baremetal host. Setup container on LXC Host In order to give Docker in the guest privileges, the guest container itself has to be given privileges. There is no simple switch for doing this in LXC unfortunately, but a few config options will do the trick. lxc launch images:ubuntu/bionic container lxc config set container security.nesting true lxc config set container security.privileged true cat &lt;&lt;EOT | lxc config set container raw.lxc - lxc.cgroup.devices.allow = a lxc.cap.drop = EOT lxc restart container Setup docker on container Just to verify that this works, start a privileged Docker container …">
		<meta name="author" content="Robert Foss">
		<meta name="keywords" content="Robert Foss memcpy Robert Foss, Open Source, Software, Linux, Kernel, Embedded, Engineer, linux, virtualization, lxc, lxd, docker, privileged">
		<meta property="og:title" content="Running Docker privileged inside of LXC / LXD" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="https://memcpy.io/images/2018-12-03_docker.png" />
		<meta property="og:url" content="https://memcpy.io/running-docker-privileged-inside-of-lxc-lxd.html" />
		<meta property="og:locale" content="" />
		<meta property="og:site_name" content="memcpy.io" />
		<meta property="article:published_time" content="2018-12-03" />
		<meta property="article:section" content="linux" />
		<meta property="article:tag" content="linux" />
		<meta property="article:tag" content="virtualization" />
		<meta property="article:tag" content="lxc" />
		<meta property="article:tag" content="lxd" />
		<meta property="article:tag" content="docker" />
		<meta property="article:tag" content="privileged" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:creator" content="@memcpy_io" />
		<meta name="twitter:site" content="@memcpy_io" />
		<meta name="twitter:title" content="Running Docker privileged inside of LXC / LXD" />
		<meta name="twitter:description" content="Being able to run Docker containers inside of LXC containers comes in quite handy due to them solving slightly different issues." />
		<meta name="twitter:image" content="https://memcpy.io/images/2018-12-03_docker.png" />
	</head>
	<body>
		<article id="content" itemscope>
			<header>
				<h1>Running Docker privileged inside of LXC / LXD</h1>
				<p>
				Published <time datetime="2018-12-03" itemprop="datePublished">2018-12-03</time>
				</p>
			</header>
			<p>Being able to run Docker containers inside of LXC containers comes in quite handy due to them solving slightly different issues.</p>
			<p>The architecture is a bit of container matroska, but what we're trying to
achieve is running Docker privileged inside of a LXC container on a baremetal
host.</p>
<p><a href="/images/2018-12-03_docker.png"><img alt="Alt text" src="/images/2018-12-03_docker.png" title="Docker running inside of LXC">
</a></p>
<h2>Setup container on LXC Host</h2>
<p>In order to give Docker in the guest privileges, the guest container
itself has to be given privileges.</p>
<p>There is no simple switch for doing this in LXC unfortunately, but a few
config options will do the trick.</p>
<div class="highlight"><pre><span></span><code>lxc launch images:ubuntu/bionic container

lxc config set container security.nesting true
lxc config set container security.privileged true
cat &lt;&lt;EOT | lxc config set container raw.lxc -
lxc.cgroup.devices.allow = a
lxc.cap.drop =
EOT

lxc restart container
</code></pre></div>

<h2>Setup docker on container</h2>
<p>Just to verify that this works, start a privileged Docker container inside
of the LXC container.</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">lxc</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">bash</span><span class="w"></span>
<span class="o">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">privileged</span><span class="w"> </span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="w"></span>
<span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">find</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="s1">&#39;hello-world:latest&#39;</span><span class="w"> </span><span class="n">locally</span><span class="w"></span>
<span class="n">latest</span><span class="p">:</span><span class="w"> </span><span class="n">Pulling</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">library</span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="w"></span>
<span class="n">d1725b59e92d</span><span class="p">:</span><span class="w"> </span><span class="n">Pull</span><span class="w"> </span><span class="n">complete</span><span class="w"></span>
<span class="n">Digest</span><span class="p">:</span><span class="w"> </span><span class="n">sha256</span><span class="p">:</span><span class="mi">0</span><span class="n">add3ace90ecb4adbf7777e9aacf18357296e799f81cabc9fde470971e499788</span><span class="w"></span>
<span class="n">Status</span><span class="p">:</span><span class="w"> </span><span class="n">Downloaded</span><span class="w"> </span><span class="n">newer</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">hello</span><span class="o">-</span><span class="n">world</span><span class="p">:</span><span class="n">latest</span><span class="w"></span>

<span class="n">Hello</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">Docker</span><span class="o">!</span><span class="w"></span>
<span class="n">This</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">shows</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">installation</span><span class="w"> </span><span class="n">appears</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">correctly</span><span class="o">.</span><span class="w"></span>

<span class="n">To</span><span class="w"> </span><span class="n">generate</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">took</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">steps</span><span class="p">:</span><span class="w"></span>
<span class="mf">1.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="n">contacted</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">daemon</span><span class="o">.</span><span class="w"></span>
<span class="mf">2.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">daemon</span><span class="w"> </span><span class="n">pulled</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="s2">&quot;hello-world&quot;</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">Hub</span><span class="o">.</span><span class="w"></span>
<span class="p">(</span><span class="n">amd64</span><span class="p">)</span><span class="w"></span>
<span class="mf">3.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">daemon</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">runs</span><span class="w"> </span><span class="n">the</span><span class="w"></span>
<span class="n">executable</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">produces</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">reading</span><span class="o">.</span><span class="w"></span>
<span class="mf">4.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">daemon</span><span class="w"> </span><span class="n">streamed</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="n">it</span><span class="w"></span>
<span class="n">to</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">terminal</span><span class="o">.</span><span class="w"></span>

<span class="n">To</span><span class="w"> </span><span class="n">try</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">ambitious</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">Ubuntu</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">with</span><span class="p">:</span><span class="w"></span>
<span class="o">$</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">ubuntu</span><span class="w"> </span><span class="n">bash</span><span class="w"></span>

<span class="n">Share</span><span class="w"> </span><span class="n">images</span><span class="p">,</span><span class="w"> </span><span class="n">automate</span><span class="w"> </span><span class="n">workflows</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">free</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w"></span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">hub</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="w"></span>

<span class="n">For</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">examples</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">ideas</span><span class="p">,</span><span class="w"> </span><span class="n">visit</span><span class="p">:</span><span class="w"></span>
<span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">docs</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">get</span><span class="o">-</span><span class="n">started</span><span class="o">/</span><span class="w"></span>
</code></pre></div>

<h2>Thanks</h2>
<p>This write-up is based <a href="https://github.com/lxc/lxd/issues/4902">info</a> provided
by Stéphane Graber.</p>
		</article>
		<section id="teaser-section">
			<div id="teaser">
				<p>Tags:
					<a href="https://memcpy.io/tag/linux.html">linux </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/virtualization.html">virtualization </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/lxc.html">lxc </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/lxd.html">lxd </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/docker.html">docker </a>
					<span id="breakdot">&middot; </span>
					<a href="https://memcpy.io/tag/privileged.html">privileged </a>
				</p>
			</div>
		</section>
		<footer>
			<div id="footer">
				<p id="notices" class="smcp">
					<a href="/about.html">About</a>
					<span id="breakdot">&middot;</span>
					<a href="/index.html">Blog</a>
					<span id="breakdot">&middot;</span>
					<a href="/talks.html">Talks</a>
					<span id="breakdot">&middot;</span>
					<a href="/contact.html">Contact</a>
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss">GitHub</a>
					<br>
					<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Copyleft</a>
					<span id="breakdot">&middot;</span>
					2022 Robert Foss
					<span id="breakdot">&middot;</span>
					<a href="https://github.com/robertfoss/memcpy.io">Source</a>
					<br>
					<a href="/"><img src="/logo.svg"></a>
				</p>
			</div>
		</footer>
	</body>
</html>